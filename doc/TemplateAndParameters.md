Table of Contents
=================

   * [Template and Parameters](#template-and-parameters)
      * [Overview](#overview)
      * [Fixed Parameters for Interrupt Controller](#fixed-parameters-for-interrupt-controller)
      * [Fixed Parameters for Timer](#fixed-parameters-for-timer)
      * [Fixed Parameters for MMIO Region](#fixed-parameters-for-mmio-region)

Created by [gh-md-toc](https://github.com/ekalinin/github-markdown-toc)

# Template and Parameters

## Overview

A QEMU virtual machine is automatically generated by an abstract representation
with respect to the device tree file of a SoC.
We have three types of abstract representations for Interrupt Controller, Timer,
and other peripherals. Each abstract representation consists of
a QEMU registration template and a QEMU hardware implementation template.
If we reuse a peripheral in QEMU, then the QEMU hardware implementation is already there;
otherwise, we have manually or automatically generate the QEMU hardware implementation
by filling parameters into the QEMU hardware implementation template 
(which is mainly talked about in the paper).

Here is the flow of the QEMU virtual machine synthesis.
Things in box with * are handled manually.


```txt
                         +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+ 
                         | CPU (model, ...)                  | <model, dynamic parameters> |
+------+-----+-----+     | Memory ('ram', base, size, ...)   +-----+-----+-----+-----+-----+
| device tree file | --->| Interrupt Controller (model, base, size, ...)                   |
+------+-----+-----+     | Timer  (model, base, size, interrupt, ...)                      |
                         | Serial (model, base, size, reg_shift, interrupt, ...)           |
                         | Others (model, base, size, ...)                                 |
                         +-----+-----+-----+-----+-----+--+--+-----+-----+-----+-----+-----+
                                       |                                                            
                                       | 
                                       |                                                           
+*****+*****+*****+*****+*****+*****+  v   +--+--+-----+-----+-----+-----+-----+            
| <model, QEMU registration APIs*>  | ---> | <model, QEMU registration APIs^>  | -----------+
+*****+*****+*****+*****+*****+*****+      +-----+-----+-----+-----+-----+-----+            |    +-----+-----+----+
                                *template                                  ^implementation  |    |  machine.c/h   | 
                                                                                            +--->+-----+-----+----+
                                *template                                  ^implementation  |    | peripheral.c/h |
+*****+*****+*****+*****+*****+*****+      +-----+-----+-----+-----+-----+-----+            |    +-----+-----+----+
| <model, QEMU hw implementation*>  | ---> | <model, QEMU hw implementation^>  | -----------+
+*****+*****+*****+*****+*****+*****+  ^   +-----+-----+-----+-----+-----+-----+            
```                                    |
                                       |
                                 +*****+*****+*****+*****+*****+*****+*****+*****+*****+***+ 
                                 |                             | <model, fixed parameters> |
+------+-----+-----+-----+-+     |                             +-----+-----+-----+-----+---+
| Linux kernel source code | --->| Interrupt Controller (r/w seqs)                         |
+------+-----+-----+-----+-+     | Timer  (r/w seqs, semantics)                            |
                                 | Others (initial values)                                 |
                                 +*****+*****+*****+*****+*****+*****+*****+*****+*****+***+
                                                      (We automated this part in out paper.)
```

## Fixed Parameters for Interrupt Controller

|parameter|description|
|:---:|:---|
|{regs_addr, regs_value}|The address of the MMIO and its initial value|
|{irqn, set_handler, clear_handler}|IRQ and the regs set/clear handlers when it happens.|
|{ack_hint, mask_hint, unmask_hint}|The hint of the state `ack`, `mask`, `unmask`.|

Where to find them?
+ irq_domain_add_simple
+ irq_domain_add_legacy
+ irq_domain_add_linear
+ __irq_domain_add
+ __irq_set_handler
+ irq_set_chained_handler
+ irq_set_chip_and_handler_name
+ irq_set_chained_handler_and_data
+ set_handle_irq (ARM)
+ plat_irq_dispatch (MIPS)

## Fixed Parameters for Timer

|parameter|description|
|:---:|:---|
|rate|The rate of the clock source/event device|
|counter_addr|The address of the counter for timekeeping and scheduled clock.|
|n_bits|The number of bits of the counter.|
|monotone|Whether the counter counts down or not.|

Where to find them?
+ clocksource_register_hz
+ clocksource_mmio_init
+ clocksource_register
+ __clocksource_register_scale
+ sched_clock_register
+ clockevents_config_and_register
+ clockevents_register_device
+ clk_register
+ clk_hw_register
+ clk_get_sys
+ clkdev_add
+ register_current_timer_delay

## Fixed Parameters for MMIO Region

|parameter|description|
|:---:|:---|
|addr|The address of the MMIO to be manipulated.|
|size|The size of the MMIO to be manipulated.|
|value|The initial value of the MMIO.|

Where to find them?
+ setup_arch
+ do_initcall_level
