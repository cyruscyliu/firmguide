# FirmGuide rendering system

A QEMU virtual machine is automatically generated by
abstract representations of peripherals on a SoC.
We have three types of abstract representations for Interrupt Controller, Timer,
and any other peripherals. Each abstract representation consists of
a QEMU registration APIs template and a QEMU hardware implementation template.
If we reuse a peripheral in QEMU, then the QEMU hardware implementation is already there;
otherwise, we have to concretize the abstract representation of each peipheral
by manually and automatically infer parameters used in the abstraction

Here is the flow of the QEMU virtual machine synthesis.
Above the line of @, the dynamic parameters and QEMU registeration APIs
are maintained by FirmGuide. The dynamic parameters are generated from a device tree file.
The QEMU registeration APIs are already or can be automatically prepared.
Below the line of @,
the QEMU hw implementation template is prepared manually and
the fixed parameters that have to be infered manullay or automatically from the source code
should be coordinated with the QEMU hw implementation template.
All concretization from template to implementaiton is automatic and the final code generation is also automatic.

By default, FirmGuide provides two sets of QEMU hw implementation template
and ways of fixed parameters inference.
Please check [Manual FirmGuide offline](Manual-FirmGuide-offline.md) 
and [Automatic FirmGuide offline](Automatic-FirmGuide-offline.md), respectively.


```txt
                         +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+ 
                         | CPU (model, ...)                  | <model, dynamic parameters> |
+------+-----+-----+     | Memory ('ram', base, size, ...)   +-----+-----+-----+-----+-----+
| device tree file | --->| Interrupt Controller (model, base, size, ...)                   |
+------+-----+-----+     | Timer  (model, base, size, interrupt, ...)                      |
                         | Serial (model, base, size, reg_shift, interrupt, ...)           |
                         | Others (model, base, size, ...)                                 |
                         +-----+-----+-----+-----+-----+--+--+-----+-----+-----+-----+-----+
                                       |                                                            
                                       | 
                                       |                                                           
+-----+-----+-----+-----+-----+-----+  v   +--+--+-----+-----+-----+-----+-----+            
| <model, QEMU registration APIs*>  | ---> | <model, QEMU registration APIs^>  | -----------+
+-----+-----+-----+-----+-----+-----+      +-----+-----+-----+-----+-----+-----+            |    +-----+-----+----+
                                *template                                  ^implementation  |    |  machine.c/h   | 
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+--->+-----+-----+----+
                                *template                                  ^implementation  |    | peripheral.c/h |
+*****+*****+*****+*****+*****+*****+      +-----+-----+-----+-----+-----+-----+            |    +-----+-----+----+
| <model, QEMU hw implementation*>  | ---> | <model, QEMU hw implementation^>  | -----------+
+*****+*****+*****+*****+*****+*****+  ^   +-----+-----+-----+-----+-----+-----+            
                                       |
                                       |
                                 +*****+*****+*****+*****+*****+*****+*****+*****+*****+***+ 
                                 |                             | <model, fixed parameters> |
+------+-----+-----+-----+-+     |                             +-----+-----+-----+-----+---+
| Linux kernel source code | --->| Interrupt Controller (r/w seqs)                         |
+------+-----+-----+-----+-+     | Timer  (r/w seqs, semantics)                            |
                                 | Others (initial values)                                 |
                                 +*****+*****+*****+*****+*****+*****+*****+*****+*****+***+
                                                      (We automated this part in out paper.)
```